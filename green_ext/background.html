<html>
<head>
<script>

function errorHandler() {
	console.log('fail', arguments);
}
function init() {
	window.requestFileSystem( PERSISTENT, 5242880 /* ~5MB */, function(fs){
    						
			    fsys = fs;
			    root = fsys.root;
	}, errorHandler);

	db = openDatabase("green", '1.0', 'image database', 15 * 1024 * 1024);
	db.transaction(function(tx) {
		tx.executeSql('create table if not exists img(name varchar(25) not null primary key asc, content text)', []);
	});
}
function loadImg(name, src, tab) {
	var img = new Image();
	img.onload = function() {
            var canvas = document.getElementById('canvas');
            var context = canvas.getContext('2d');
            context.drawImage(img, 0, 0);
            var data = canvas.toDataURL();

            chrome.extension.getExtensionTabs()[0].app.loadImage(data);

			// write(name, data) // write to file
			writeDB(name, data);

    };
    img.src = src;
}
function writeDB(name, data) {
	db.transaction(function(tx) {
		tx.executeSql('insert into img values (?,?)', [name, data]);
	});
}

function readDB(name, callback) {
	db.transaction(function(tx) {
		tx.executeSql('select content from img where name = ?', [name], function(tx, rs) {
			console.log(tx, rs);
			var row = rs.rows.item(0);
			callback(row.content);
		})
	})
}

function write(name, data) {
	root.getFile(name, {create: true}, function(fileEntry) {
		fileEntry.createWriter(function(fileWriter) {
			fileWriter.onwriteend = function(e) {
				console.log('write success');
			}
			fileWriter.onerror = function(e) {
				console.log('write error');
			}
			var bb = new WebKitBlobBuilder();
			bb.append(data);
			window.pok = bb;
			fileWriter.write(bb.getBlob('text/plain'));
		}, errorHandler)

	}, errorHandler)	
}
function read(name, callback) {
	fsys.root.getFile(name, {}, function(fe) {
		fe.file(function(file) {
			var reader = new FileReader();
			reader.onloadend = function(e) {
				 console.log('load end');
				 console.log(this.result);
				 callback(this.result);
 	        };
 	        reader.readAsDataURL(file);
		}, errorHandler)
	}, errorHandler);
}
</script>
</head>
<body>
<canvas id="canvas">
</canvas>
</body>
</html>